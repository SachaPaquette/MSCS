<UserControl x:Class="MSCS.Views.ReaderSidebar"
             x:Name="Root"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:MSCS.Views"
             Background="{DynamicResource SidebarBackground}"
             Foreground="{DynamicResource SidebarText}"
             MinWidth="260" Width="300">
    <UserControl.Resources>
        <!-- chapters view with text filter (handled in code-behind) -->
        <CollectionViewSource x:Key="ChaptersView"
                              Source="{Binding ElementName=Root, Path=ItemsSource}"
                              Filter="ChaptersView_Filter"/>
    </UserControl.Resources>

    <Border Background="{DynamicResource SidebarBackground}"
            BorderBrush="{DynamicResource SurfaceBorderSoft}"
            BorderThickness="1"
            CornerRadius="10"
            Padding="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="8"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="10"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header: Home + Title (optional) -->
            <DockPanel Grid.Row="0">
                <Button Content="Home"
                        Command="{Binding ElementName=Root, Path=HomeCommand}"
                        Padding="10,6"
                        Margin="0,0,8,0"
                        DockPanel.Dock="Left"/>
                <TextBlock Text="Chapters"
                           Foreground="{DynamicResource SidebarText}"
                           VerticalAlignment="Center"
                           FontWeight="SemiBold"/>
            </DockPanel>

            <Button Grid.Row="2"
                    Content="{Binding TrackButtonText}"
                        Margin="0,12,0,0"
                        HorizontalAlignment="Right"
                        Style="{StaticResource AccentButton}"
                        Command="{Binding TrackCommand}"
                        Visibility="{Binding HasTrackingProviders, Converter={StaticResource BooleanToVisibilityConverter}}"
                        ToolTip="{Binding ActiveTrackerName, StringFormat=Manage {0} tracking, TargetNullValue=Manage tracking}"/>


            <StackPanel Grid.Row="4"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Visibility="{Binding IsLoadingChapters, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ProgressBar Width="120"
                             Height="6"
                             IsIndeterminate="True"/>
                <TextBlock Text="Loading chapters..."
                           Foreground="{DynamicResource SidebarText}"
                           Margin="12,0,0,0"
                           VerticalAlignment="Center"/>
            </StackPanel>

            <TextBlock Grid.Row="5"
                       Text="No chapters match your filters."
                       Foreground="{DynamicResource SidebarText}"
                       HorizontalAlignment="Center"
                       Margin="0,12,0,0"
                       Visibility="{Binding IsEmptyAfterFilter, Converter={StaticResource BooleanToVisibilityConverter}}"/>

            <!-- List -->
            <ListBox Grid.Row="6"
                     x:Name="ChaptersList"
                     ItemsSource="{Binding Source={StaticResource ChaptersView}}"
                     SelectedItem="{Binding ElementName=Root, Path=SelectedItem, Mode=TwoWay}"
                     IsTabStop="True"
                     BorderThickness="0"
                     Background="{DynamicResource SidebarBackground}"
                     Foreground="{DynamicResource SidebarText}"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     SelectionChanged="ChaptersList_OnSelectionChanged">
                <ListBox.Style>
                    <Style TargetType="ListBox">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsLoadingChapters}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsEmptyAfterFilter}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.Style>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Title}"
                                   Margin="8,6"
                                   TextTrimming="CharacterEllipsis"/>
                    </DataTemplate>
                </ListBox.ItemTemplate>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="2"/>
                        <Setter Property="Margin"  Value="0,2"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="{DynamicResource SurfaceBorder}"/>
                        <Setter Property="FocusVisualStyle">
                            <Setter.Value>
                                <Style TargetType="Control">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Control">
                                                <Border BorderBrush="{StaticResource Accent}"
                                                        BorderThickness="2"
                                                        CornerRadius="6"
                                                        Margin="1"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Style.Triggers>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsKeyboardFocusWithin" Value="True"/>
                                    <Condition Property="IsSelected" Value="False"/>
                                </MultiTrigger.Conditions>
                                <Setter Property="BorderBrush" Value="{StaticResource Accent}"/>
                                <Setter Property="Background" Value="#2A3750"/>
                            </MultiTrigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ControlHover}"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ControlPressed}"/>
                                <Setter Property="BorderBrush" Value="{DynamicResource Accent}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.ItemContainerStyle>
            </ListBox>
        </Grid>
    </Border>
</UserControl>