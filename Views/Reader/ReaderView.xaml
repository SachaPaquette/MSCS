<UserControl x:Class="MSCS.Views.ReaderView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:MSCS.Converters"
             xmlns:enums="clr-namespace:MSCS.Enums"
             Background="{Binding ReaderBackgroundBrush, FallbackValue=#0F151F}"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch"
             Focusable="True"
             FocusVisualStyle="{x:Null}"
             Loaded="UserControl_Loaded"
             Unloaded="UserControl_Unloaded"
             PreviewKeyDown="UserControl_PreviewKeyDown">

    <UserControl.Resources>
        <ResourceDictionary>

            <conv:ViewportFractionConverter x:Key="ViewportFraction"/>
            <conv:BooleanOrConverter x:Key="BooleanOr"/>
            <conv:ChapterImageSourceConverter x:Key="ChapterImageSource"/>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <ItemsPanelTemplate x:Key="VerticalPanelTemplate">
                <VirtualizingStackPanel Orientation="Vertical"/>
            </ItemsPanelTemplate>

            <Style x:Key="AccentButton" TargetType="Button">
                <Setter Property="Background" Value="#7C9CFF" />
                <Setter Property="Foreground" Value="White" />
                <Setter Property="Padding" Value="14,6" />
                <Setter Property="BorderBrush" Value="{x:Null}" />
                <Setter Property="Cursor" Value="Hand" />
                <Setter Property="BorderThickness" Value="0" />
                <Setter Property="FontWeight" Value="SemiBold" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="Border"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="6"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Border" Property="Background" Value="#91ACFF" />
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="Border" Property="Background" Value="#6987F7" />
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter TargetName="Border" Property="Opacity" Value="0.5" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding Key="Right"
                    Modifiers="Control"
                    Command="{Binding NextChapterCommand}"/>
        <KeyBinding Key="Left"
                    Modifiers="Control"
                    Command="{Binding PreviousChapterCommand}"/>
        <KeyBinding Key="N"
                    Modifiers="Control"
                    Command="{Binding NextChapterCommand}"/>
        <KeyBinding Key="P"
                    Modifiers="Control"
                    Command="{Binding PreviousChapterCommand}"/>
        <KeyBinding Key="D1"
                    Modifiers="Control"
                    Command="{Binding SetZoomPresetCommand}"
                    CommandParameter="0.6"/>
        <KeyBinding Key="D2"
                    Modifiers="Control"
                    Command="{Binding SetZoomPresetCommand}"
                    CommandParameter="0.75"/>
        <KeyBinding Key="D3"
                    Modifiers="Control"
                    Command="{Binding SetZoomPresetCommand}"
                    CommandParameter="0.9"/>
        <KeyBinding Key="D0"
                    Modifiers="Control"
                    Command="{Binding ResetZoomCommand}"/>
        <KeyBinding Key="Add"
                    Modifiers="Control"
                    Command="{Binding IncreaseZoomCommand}"/>
        <KeyBinding Key="Subtract"
                    Modifiers="Control"
                    Command="{Binding DecreaseZoomCommand}"/>
        <KeyBinding Key="OemPlus"
                    Modifiers="Control"
                    Command="{Binding IncreaseZoomCommand}"/>
        <KeyBinding Key="OemMinus"
                    Modifiers="Control"
                    Command="{Binding DecreaseZoomCommand}"/>
        <KeyBinding Key="D1"
                    Modifiers="Control+Shift"
                    Command="{Binding SetScrollPresetCommand}"
                    CommandParameter="{x:Static enums:ReaderScrollPreset.Compact}"/>
        <KeyBinding Key="D2"
                    Modifiers="Control+Shift"
                    Command="{Binding SetScrollPresetCommand}"
                    CommandParameter="{x:Static enums:ReaderScrollPreset.Balanced}"/>
        <KeyBinding Key="D3"
                    Modifiers="Control+Shift"
                    Command="{Binding SetScrollPresetCommand}"
                    CommandParameter="{x:Static enums:ReaderScrollPreset.Immersive}"/>
    </UserControl.InputBindings>

    <Grid>
        <ScrollViewer x:Name="ScrollView"
                      Background="{Binding ReaderSurfaceBrush, FallbackValue=#111727}"
                      PanningMode="Both"
                      ScrollChanged="ScrollViewer_ScrollChanged">
            <ScrollViewer.Style>
                <Style TargetType="ScrollViewer">
                    <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
                    <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
                </Style>
            </ScrollViewer.Style>
            <ItemsControl ItemsSource="{Binding ImageUrls}"
                          ScrollViewer.CanContentScroll="False"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          VirtualizingPanel.CacheLength="1">
                <ItemsControl.Style>
                    <Style TargetType="ItemsControl">
                        <Setter Property="ItemsPanel" Value="{StaticResource VerticalPanelTemplate}"/>
                        <Setter Property="Margin" Value="0"/>
                    </Style>
                </ItemsControl.Style>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="HorizontalAlignment" Value="Center"/>
                        <Setter Property="Margin" Value="0,0,0,0"/>
                    </Style>
                </ItemsControl.ItemContainerStyle>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Image Stretch="Uniform"
                               Margin="0"
                               SnapsToDevicePixels="True"
                               UseLayoutRounding="True"
                               RenderOptions.BitmapScalingMode="HighQuality"
                               MouseLeftButtonDown="Image_MouseLeftButtonDown"
                               Source="{Binding Converter={StaticResource ChapterImageSource}}">
                            <Image.Width>
                                <MultiBinding Converter="{StaticResource ViewportFraction}">
                                    <Binding ElementName="ScrollView" Path="ViewportWidth"/>
                                    <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.WidthFactor"/>
                                    <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.MaxPageWidth"/>
                                </MultiBinding>
                            </Image.Width>
                        </Image>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <Border HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="12"
                Padding="12"
                CornerRadius="8"
                Background="{Binding ReaderSurfaceBrush, FallbackValue=#111727}"
                Opacity="0.85"
                BorderBrush="#263149"
                BorderThickness="1">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=IsFullscreenMode}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding TotalImages}" Value="0">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <Border.Effect>
                <DropShadowEffect BlurRadius="16" ShadowDepth="0" Opacity="0.3"/>
            </Border.Effect>
            <StackPanel>
                <TextBlock Text="{Binding ChapterTitle}"
                           Foreground="#E9EEF7"
                           FontWeight="SemiBold"
                           TextTrimming="CharacterEllipsis"
                           Margin="0,0,0,6"/>
                <ProgressBar Minimum="0"
                             Maximum="1"
                             Height="6"
                             Margin="0,0,0,8"
                             Value="{Binding ScrollProgress, Mode=OneWay}"/>
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <TextBlock Text="{Binding LoadedImages}"
                               Foreground="#C5CBD6"
                               FontWeight="SemiBold"/>
                    <TextBlock Text=" / " Foreground="#C5CBD6"/>
                    <TextBlock Text="{Binding TotalImages}"
                               Foreground="#C5CBD6"/>
                    <TextBlock Text="  •  " Foreground="#3E4B63"/>
                    <TextBlock Text="{Binding ScrollProgress, StringFormat={}{0:P0}}"
                               Foreground="#C5CBD6"/>
                </StackPanel>
            </StackPanel>
        </Border>
        <Grid x:Name="SidebarHost"
              HorizontalAlignment="Left"
              VerticalAlignment="Stretch"
              Margin="4,0,0,0"
              Panel.ZIndex="10"
              Background="Transparent">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=IsFullscreenMode}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0"
                        VerticalAlignment="Top">
                <Button Style="{StaticResource IconButtonStyle}"
                        Command="{Binding GoBackCommand}"
                        ToolTip="Back"
                        Margin="0,0,0,16">
                    <TextBlock Text="&#xE72B;" FontSize="16"/>
                </Button>

                <Button x:Name="PinBtn"
                        Style="{StaticResource IconButtonStyle}"
                        ToolTip="Chapters / Home"
                        Margin="0,0,0,8">
                    <TextBlock Text="&#xE718;" FontSize="16"/>
                </Button>

                <Button x:Name="FullscreenButton"
                        Style="{StaticResource IconButtonStyle}"
                        ToolTip="Enter fullscreen"
                        Click="FullscreenButton_Click">
                    <TextBlock x:Name="FullscreenButtonIcon"
                               FontSize="16"
                               Text="&#xE740;"/>
                </Button>
            </StackPanel>


            <Border x:Name="ChapterSidebar"
                    Grid.Column="1"
                    Margin="8,4,0,4"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Background="{Binding ReaderSurfaceBrush, FallbackValue=#202737}"
                    BorderBrush="#263149"
                    BorderThickness="1"
                    CornerRadius="10"
                    Padding="10"
                    Width="300"
                    SnapsToDevicePixels="True">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Value="True">
                                <DataTrigger.Binding>
                                    <MultiBinding Converter="{StaticResource BooleanOr}">
                                        <Binding ElementName="PinBtn" Path="IsMouseOver"/>
                                        <Binding RelativeSource="{RelativeSource Self}" Path="IsMouseOver"/>
                                        <Binding ElementName="SidebarHost" Path="IsMouseOver"/>
                                    </MultiBinding>
                                </DataTrigger.Binding>
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Home -->
                    <Button Grid.Row="0"
                            Style="{StaticResource IconButtonStyle}"
                            Command="{Binding GoHomeCommand}"
                            HorizontalAlignment="Left">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="&#xE10F;" Margin="0,0,6,0"/>
                            <TextBlock Text="Home"/>
                        </StackPanel>
                    </Button>

                    <!-- Reader preferences -->
                    <StackPanel Grid.Row="2"
                                Orientation="Vertical">
                        <TextBlock Text="Reader preferences"
                                   FontWeight="SemiBold"
                                   Foreground="#E9EEF7"/>
                        <TextBlock Text="Zoom"
                                   Margin="0,10,0,0"
                                   Foreground="#8F9BB4"
                                   FontSize="12"/>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Slider Width="160"
                                    Minimum="0.3"
                                    Maximum="1.0"
                                    TickFrequency="0.05"
                                    IsSnapToTickEnabled="True"
                                    Value="{Binding WidthFactor, Mode=TwoWay}"
                                    ToolTip="Adjust the relative page width"
                                    Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding ZoomPercent, StringFormat={}{0:F0}%}"
                                       Foreground="#E9EEF7"
                                       FontWeight="SemiBold"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <Button Content="-" Width="32" Height="28" Command="{Binding DecreaseZoomCommand}" ToolTip="Zoom out" Margin="0,0,6,0"/>
                            <Button Content="Reset" Height="28" Command="{Binding ResetZoomCommand}" ToolTip="Reset zoom" Margin="0,0,6,0"/>
                            <Button Content="+" Width="32" Height="28" Command="{Binding IncreaseZoomCommand}" ToolTip="Zoom in"/>
                        </StackPanel>
                        <TextBlock Text="Theme"
                                   Margin="0,10,0,0"
                                   Foreground="#8F9BB4"
                                   FontSize="12"/>
                        <ComboBox SelectedValue="{Binding Theme}"
                                  SelectedValuePath="Tag"
                                  Margin="0,2,0,0"
                                  ToolTip="Change the reader color palette">
                            <ComboBoxItem Content="Midnight" Tag="{x:Static enums:ReaderTheme.Midnight}"/>
                            <ComboBoxItem Content="Pure black" Tag="{x:Static enums:ReaderTheme.PureBlack}"/>
                            <ComboBoxItem Content="Sepia" Tag="{x:Static enums:ReaderTheme.Sepia}"/>
                            <ComboBoxItem Content="High contrast" Tag="{x:Static enums:ReaderTheme.HighContrast}"/>
                        </ComboBox>
                    </StackPanel>


                    <!-- Manga info + tracking -->
                    <Grid Grid.Row="4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Vertical" Margin="0,0,12,0">
                            <TextBlock Text="{Binding MangaTitle}"
                                       Foreground="#E9EEF7"
                                       FontWeight="SemiBold"
                                       TextTrimming="CharacterEllipsis" />
                            <TextBlock Text="{Binding ChapterTitle}"
                                       Foreground="#8F9BB4"
                                       FontSize="12"
                                       TextTrimming="CharacterEllipsis" />
                            <StackPanel Orientation="Vertical"
                                        Margin="0,6,0,0"
                                        Visibility="{Binding IsAniListTracked, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="{Binding AniListStatusDisplay}"
                                           Foreground="#8F9BB4"
                                           FontSize="12" />
                                <TextBlock Text="{Binding AniListProgressDisplay}"
                                           Foreground="#8F9BB4"
                                           FontSize="12" />
                                <TextBlock Text="{Binding AniListScoreDisplay}"
                                           Foreground="#8F9BB4"
                                           FontSize="12" />
                                <TextBlock Text="{Binding AniListUpdatedDisplay}"
                                           Foreground="#60708E"
                                           FontSize="11" />
                            </StackPanel>
                        </StackPanel>
                        <StackPanel Grid.Column="1"
                                    Orientation="Vertical"
                                    HorizontalAlignment="Right"
                                    Visibility="{Binding IsAniListAvailable, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="{Binding AniListButtonText}"
                                    Style="{StaticResource AccentButton}"
                                    Command="{Binding AniListTrackCommand}"
                                    ToolTip="Manage AniList tracking" />
                            <Button Content="Open AniList"
                                    Margin="0,6,0,0"
                                    Command="{Binding AniListOpenInBrowserCommand}"
                                    Visibility="{Binding IsAniListTracked, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    ToolTip="Open this series on AniList" />
                            <Button Content="Remove"
                                    Margin="0,6,0,0"
                                    Command="{Binding AniListRemoveTrackingCommand}"
                                    Visibility="{Binding IsAniListTracked, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    ToolTip="Remove AniList tracking" />
                        </StackPanel>
                    </Grid>

                    <!-- Chapter list -->
                    <Border Grid.Row="6"
                            Background="{Binding ReaderSurfaceBrush, FallbackValue=#1A2230}"
                            CornerRadius="6"
                            Padding="2"
                            VerticalAlignment="Stretch">
                        <ListBox ItemsSource="{Binding Chapters}"
                                 SelectedItem="{Binding SelectedChapter, Mode=TwoWay}"
                                 BorderThickness="0"
                                 Background="Transparent"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                 VirtualizingStackPanel.IsVirtualizing="True"
                                 VirtualizingStackPanel.VirtualizationMode="Recycling">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Foreground" Value="#E9EEF7"/>
                                    <Setter Property="Padding" Value="8,6"/>
                                    <Setter Property="Margin" Value="0,2"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="ItemBorder"
                                                        Background="Transparent"
                                                        CornerRadius="4">
                                                    <ContentPresenter VerticalAlignment="Center" Margin="4,0"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="ItemBorder" Property="Background" Value="#2A3A53"/>
                                                    </Trigger>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="ItemBorder" Property="Background" Value="#3C4F6D"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Title}"
                                               Foreground="#E9EEF7"
                                               FontWeight="SemiBold"
                                               TextTrimming="CharacterEllipsis"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>