<UserControl x:Class="MSCS.Views.ReaderView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:MSCS.ViewModels"
             xmlns:conv="clr-namespace:MSCS.Converters"
             xmlns:enums="clr-namespace:MSCS.Enums"
             xmlns:reader="clr-namespace:MSCS.Views.Reader"
             Background="{Binding Preferences.ReaderBackgroundBrush, FallbackValue=#0F151F}"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch"
             Focusable="True"
             FocusVisualStyle="{x:Null}"
             Loaded="UserControl_Loaded"
             Unloaded="UserControl_Unloaded"
             PreviewKeyDown="UserControl_PreviewKeyDown">


    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="ReaderResources.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding Key="Right"
                    Modifiers="Control"
                    Command="{Binding NextChapterCommand}"/>
        <KeyBinding Key="Left"
                    Modifiers="Control"
                    Command="{Binding PreviousChapterCommand}"/>
        <KeyBinding Key="N"
                    Modifiers="Control"
                    Command="{Binding NextChapterCommand}"/>
        <KeyBinding Key="P"
                    Modifiers="Control"
                    Command="{Binding PreviousChapterCommand}"/>
        <KeyBinding Key="D1"
                    Modifiers="Control"
                    Command="{Binding Preferences.SetZoomPresetCommand}"
                    CommandParameter="0.6"/>
        <KeyBinding Key="D2"
                    Modifiers="Control"
                    Command="{Binding Preferences.SetZoomPresetCommand}"
                    CommandParameter="0.75"/>
        <KeyBinding Key="D3"
                    Modifiers="Control"
                    Command="{Binding Preferences.SetZoomPresetCommand}"
                    CommandParameter="0.9"/>
        <KeyBinding Key="D4"
                    Modifiers="Control"
                    Command="{Binding Preferences.SetZoomPresetCommand}"
                    CommandParameter="1.0"/>
        <KeyBinding Key="D0"
                    Modifiers="Control"
                    Command="{Binding Preferences.ResetZoomCommand}"/>
        <KeyBinding Key="Add"
                    Modifiers="Control"
                    Command="{Binding Preferences.IncreaseZoomCommand}"/>
        <KeyBinding Key="Subtract"
                    Modifiers="Control"
                    Command="{Binding Preferences.DecreaseZoomCommand}"/>
        <KeyBinding Key="OemPlus"
                    Modifiers="Control"
                    Command="{Binding Preferences.IncreaseZoomCommand}"/>
        <KeyBinding Key="OemMinus"
                    Modifiers="Control"
                    Command="{Binding Preferences.DecreaseZoomCommand}"/>
        <KeyBinding Key="D1"
                    Modifiers="Control+Shift"
                    Command="{Binding Preferences.SetScrollPresetCommand}"
                    CommandParameter="{x:Static enums:ReaderScrollPreset.Compact}"/>
        <KeyBinding Key="D2"
                    Modifiers="Control+Shift"
                    Command="{Binding Preferences.SetScrollPresetCommand}"
                    CommandParameter="{x:Static enums:ReaderScrollPreset.Balanced}"/>
        <KeyBinding Key="D3"
                    Modifiers="Control+Shift"
                    Command="{Binding Preferences.SetScrollPresetCommand}"
                    CommandParameter="{x:Static enums:ReaderScrollPreset.Immersive}"/>
        <KeyBinding Key="T"
                    Modifiers="Control"
                    Command="{Binding Preferences.TogglePageTransitionsCommand}"/>
        <KeyBinding Key="W"
                    Modifiers="Control"
                    Command="{Binding Preferences.ToggleAutoWidthCommand}"/>
        <KeyBinding Key="I"
                    Modifiers="Control"
                    Command="{Binding Preferences.ToggleImmersiveModeCommand}"/>
    </UserControl.InputBindings>

    <Grid>
        <ListBox x:Name="ImageList"
                 Background="{Binding Preferences.ReaderSurfaceBrush, FallbackValue=#111727}"
                 BorderThickness="0"
                 Padding="0"
                 HorizontalContentAlignment="Stretch"
                 ScrollViewer.CanContentScroll="True"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling"
                 VirtualizingPanel.CacheLength="1"
                 VirtualizingPanel.ScrollUnit="Pixel"
                 VirtualizingStackPanel.CleanUpVirtualizedItem="Images_CleanUpVirtualizedItem"
                 Loaded="ImageList_Loaded"
                 ItemsSource="{Binding ImageUrls}">
            <ListBox.Style>
                <Style TargetType="ListBox">
                    <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
                    <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=IsFullscreenMode}" Value="True">
                            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Hidden"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ListBox.Style>
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <VirtualizingStackPanel Orientation="Vertical"/>
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="BorderBrush" Value="Transparent"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                    <Setter Property="IsHitTestVisible" Value="True"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Image Stretch="Uniform"
                           Margin="0"
                           SnapsToDevicePixels="True"
                           UseLayoutRounding="True"
                           RenderOptions.BitmapScalingMode="HighQuality"
                           MouseLeftButtonDown="Image_MouseLeftButtonDown"
                           RenderOptions.EdgeMode="Aliased">
                        <Image.Source>
                            <Binding Converter="{StaticResource ChapterImageSource}"/>
                        </Image.Source>
                        <Image.Width>
                            <MultiBinding Converter="{StaticResource ViewportFraction}">
                                <Binding RelativeSource="{RelativeSource AncestorType=ScrollViewer}" Path="ViewportWidth"/>
                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.Preferences.WidthFactor"/>
                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.Preferences.MaxPageWidth"/>
                                <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.Preferences.AutoAdjustWidth"/>
                            </MultiBinding>
                        </Image.Width>
                    </Image>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <Border HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,44,12"
                Padding="12"
                CornerRadius="8"
                Background="{Binding Preferences.ReaderSurfaceBrush, FallbackValue={StaticResource SurfaceAlt}}"
                Opacity="0.85"
                BorderBrush="{DynamicResource SurfaceBorderSoft}"
                BorderThickness="1">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding TotalImages}" Value="0">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <Border.Effect>
                <DropShadowEffect BlurRadius="16" ShadowDepth="0" Opacity="0.3"/>
            </Border.Effect>
            <StackPanel HorizontalAlignment="Right">
                <TextBlock Text="{Binding ChapterTitle}"
                           Foreground="{DynamicResource SidebarText}"
                           FontWeight="SemiBold"
                           TextTrimming="CharacterEllipsis"
                           TextAlignment="Right"
                           Margin="0,0,0,6"/>
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <TextBlock Text="{Binding CurrentPage}"                               Foreground="{DynamicResource SidebarText}"
                               FontWeight="SemiBold"/>
                    <TextBlock Text=" / " Foreground="{DynamicResource SidebarText}"/>
                    <TextBlock Text="{Binding TotalImages}"
                               Foreground="{DynamicResource SidebarText}"/>
                    <TextBlock Text="  •  " Foreground="{DynamicResource FgSubtle}"/>
                    <TextBlock Text="{Binding CurrentPagePercentage, StringFormat={}{0:P0}}"
                               Foreground="{DynamicResource SidebarText}"/>
                </StackPanel>
            </StackPanel>
        </Border>
        <Border HorizontalAlignment="Center"
                VerticalAlignment="Bottom"
                Margin="0,0,0,40"
                Padding="20,16"
                Panel.ZIndex="6"
                CornerRadius="12"
                Background="{Binding Preferences.ReaderSurfaceBrush, FallbackValue={StaticResource SurfaceAlt}}"
                Opacity="0.92"
                BorderBrush="{DynamicResource SurfaceBorderSoft}"
                BorderThickness="1">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsChapterTransitionPreviewVisible}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <Border.Effect>
                <DropShadowEffect BlurRadius="18" ShadowDepth="0" Opacity="0.35"/>
            </Border.Effect>
            <StackPanel Width="360" TextBlock.TextAlignment="Center" TextElement.Foreground="{DynamicResource SidebarText}">
                <Button Style="{StaticResource ChapterPreviewButton}"
                        Command="{Binding PreviousChapterCommand}"
                        Margin="0,0,0,12"
                        Padding="12,8">
                    <StackPanel>
                        <TextBlock Text="Previous:"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource FgSubtle}"/>
                        <TextBlock Text="{Binding PreviousChapterDisplay, TargetNullValue=—}"
                                   TextTrimming="CharacterEllipsis"
                                   FontSize="16"
                                   Margin="0,4,0,0"/>
                    </StackPanel>
                </Button>
                <StackPanel Margin="0,0,0,12">
                    <TextBlock Text="Current:"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource FgSubtle}"/>
                    <TextBlock Text="{Binding CurrentChapterDisplay, TargetNullValue=—}"
                               TextTrimming="CharacterEllipsis"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Margin="0,4,0,0"/>
                </StackPanel>
                <Button Style="{StaticResource ChapterPreviewButton}"
                        Command="{Binding NextChapterCommand}"
                        Padding="12,8">
                    <StackPanel>
                        <TextBlock Text="Next:"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource FgSubtle}"/>
                        <TextBlock Text="{Binding NextChapterDisplay, TargetNullValue=—}"
                                   TextTrimming="CharacterEllipsis"
                                   FontSize="16"
                                   Margin="0,4,0,0"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>
        <Grid x:Name="SidebarHost"
              HorizontalAlignment="Left"
              VerticalAlignment="Stretch"
              Margin="4,0,0,0"
              Panel.ZIndex="10"
              Background="Transparent">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=IsFullscreenMode}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>


            <StackPanel Grid.Column="0"
                        VerticalAlignment="Top"
                        HorizontalAlignment="Left">
                <Border Background="{DynamicResource SurfaceAlt}"
                        BorderBrush="{DynamicResource SurfaceBorderSoft}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="6"
                        Margin="4,4,0,4"
                        SnapsToDevicePixels="True">
                    <StackPanel>
                        <Button Style="{StaticResource SidebarIconButtonStyle}"
                                Command="{Binding GoBackCommand}"
                                ToolTip="Back"
                                Margin="0,0,0,8">
                            <TextBlock Text="&#xE72B;" FontSize="16"/>
                        </Button>

                        <ToggleButton x:Name="SidebarToggleButton"
                                      Style="{StaticResource SidebarIconToggleButtonStyle}"
                                      Margin="0,0,0,8">
                            <ToggleButton.ToolTip>
                                <ToolTip>
                                    <ToolTip.Style>
                                        <Style TargetType="ToolTip">
                                            <Setter Property="Content" Value="Pin sidebar"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding PlacementTarget.IsChecked, RelativeSource={RelativeSource Self}}" Value="True">
                                                    <Setter Property="Content" Value="Unpin sidebar"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ToolTip.Style>
                                </ToolTip>
                            </ToggleButton.ToolTip>
                            <TextBlock FontSize="16">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="&#xE718;"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                                                <Setter Property="Text" Value="&#xE77A;"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </ToggleButton>

                        <Button x:Name="FullscreenButton"
                                Style="{StaticResource SidebarIconButtonStyle}"
                                ToolTip="Enter fullscreen"
                                Click="FullscreenButton_Click">
                            <TextBlock x:Name="FullscreenButtonIcon"
                                       FontSize="16"
                                       Text="&#xE740;"/>
                        </Button>
                    </StackPanel>
                </Border>
            </StackPanel>


            <Border x:Name="ChapterSidebar"
                    Grid.Column="1"
                    Margin="8,4,0,4"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Background="{DynamicResource SidebarBackground}"
                    BorderBrush="{DynamicResource SurfaceBorder}"
                    BorderThickness="1"
                    CornerRadius="10"
                    Padding="10"
                    Width="300"
                    SnapsToDevicePixels="True">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Value="True">
                                <DataTrigger.Binding>
                                    <MultiBinding Converter="{StaticResource BooleanOr}">
                                        <Binding ElementName="SidebarToggleButton" Path="IsChecked" TargetNullValue="False" FallbackValue="False"/>
                                        <Binding ElementName="SidebarToggleButton" Path="IsMouseOver"/>
                                        <Binding RelativeSource="{RelativeSource Self}" Path="IsMouseOver"/>
                                        <Binding ElementName="SidebarHost" Path="IsMouseOver"/>
                                    </MultiBinding>
                                </DataTrigger.Binding>
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>


                    <!-- Reader preferences -->

                    <TabControl Grid.Row="1"
                                Style="{StaticResource SidebarTabControlStyle}"
                                ItemContainerStyle="{StaticResource SidebarTabItemStyle}">
                        <TabItem Header="Reader">
                            <reader:ReaderPreferencesPanel/>
                        </TabItem>
                        <TabItem Header="Series">
                            <reader:ReaderSeriesPanel/>
                        </TabItem>
                        <TabItem Header="Chapters">
                            <reader:ReaderChaptersPanel/>
                        </TabItem>
                    </TabControl>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>